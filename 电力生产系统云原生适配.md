# 电力生产系统云原生适配
###  电力生产系统现状

```
  电力生产系统是一个单体应用，在设计中采用内存计算模式。
  例如：当终端用户在浏览器中创建业务表单（第一种工作票）时，
  所有填写数据的用户操作都会产生一个事件与后端交互，并等待后端响应，在时延上要求很高。
  一个业务表单可能会产生N个事件，这些事件按会话存放到后端服务器内存上，
  这些事件是有时间顺序并且含有业务逻辑。
  当终端用户保存业务表单时，才会最终在数据库进行持久。
  
  
```
### 电力生产系统常规部署
```
   一个电站对应一个电力生产系统，由Nginx路由电站用户到对应的电力生产系统。
   
   
```
``` plantuml
@startuml
   title 电力生产系统常规部署
   [ngingx] --> [电力生产系统一]
   [ngingx] --> [电力生产系统二]
   [ngingx] --> [电力生产系统三]
   [ngingx] --> [电力生产系统四]
   [ngingx] --> [电力生产系统N]
   database  电力生产数据库支持Oracle或者MySql as db
   [电力生产系统一] --> [db]
   [电力生产系统二] --> [db]
   [电力生产系统三] --> [db]
   [电力生产系统四] --> [db]
   [电力生产系统N] --> [db]
@enduml
```
####  常规部署存在的问题
```
当物理机、虚拟机的规模越大，发生停机的比率越高。
电力生产系统常规部署存在某个电站的电力生产系统发生停机等不可用，虽然只会影响这个电站，不会影响其它电站的运行，但在高可用的分数上可能只有98~99%分。距离99.99%还有不小的距离。
```
### 甲方希望电力系统能提供高可用的解决方案
```
   甲方提供云原生基础平台，提供KubeSphere方便运维和开发。
   甲方希望电力生产系统能通过无状态应有部署方式充分利有云原生基础平台能力，从而达到高可用目标。
   乙方（电力生产系统）希望能满足甲方要求的同时，能以最小的改造成本、进度进行方案设计。
```
###  解决思路

```
《人月神话》 ： 没有银弹（没有一个方案是十全十美的，我们需要依据实际情况去取舍、平衡）

思路一  共享缓存会话
思路二  依托云原生设计模式、发布订阅模式来共享内存。
由于对业务系统和使用场景了解不深，也没有进行相应的试验。
提出的方案一定会存在各种问题。
在这里抛砖引玉，希望通过本文能让各位有新的思路。
```
####  电力生产系统分析
```
    
   从云原生角度来看在规模大些的集群中网络、存储、服务没什么是可靠的，
   云原生需解决问题之一就是在不可靠中找到一种动态平衡，让集群看起来是可靠的。
   可以参考附件中“Pod异常应如何保证高可用”
   
   高可用为何要求应用是无状态？
   go设计哲学“少既是多”，“上帝爱简单”
   go 是云原生的主力开发语言，其设计哲学对云原生的理念产生很大的影响。
   设想下如果应用是有状态的，基础设施需要区分每个请求，
   需要制定规则路由把请求正确的路由到对应的服务。在对请求的解析中会大大增加复杂度。
   使得基础设施承担了太多的职责，提高的复杂度。
   
```
```
     电力生产系统在设计上使一个用户（会话）的多个请求之间是有关联，
     上一个请求会对下几个请求在一个会话中产生影响。
     因此不能保证幂等。
```

###  思路一 使用Redis完成共享会话

``` plantuml
@startuml
    title 某电厂电力生产系统部署思路二
  
   [ngingx] --> [nginx1]
   [ngingx] --> [电力生产系统四]
   [ngingx] --> [电力生产系统N]
   database  电力生产数据库支持Oracle或者MySql as db
   
   [nginx1] --> [电力生产系统31]
   [nginx1] --> [电力生产系统32]
   [nginx1] --> [电力生产系统33]
   [电力生产系统31] --> [db]
    [电力生产系统32] --> [db]
     [电力生产系统33] --> [db]
   [电力生产系统四] --> [db]
   [电力生产系统N] --> [db]
   
  [电力生产系统31] ---  [redis]
  [电力生产系统32]  ---  [redis]
  [电力生产系统33]  ---  [redis]
@enduml
```

```
  原来一个电厂部署一个电力生产系统，改为一个电厂可部署多个电力生产系统，
  当有其中一个电力生产系统出现问题，还有两个可以使用。
  ```
  利用云原生特性，当一个电力生产系统出现故障不能提供服务时，由基础平台保证服务的高可用。
  例如：平台管理员配置某电站应始终有三个电力生力系统做负载均衡。当其中一台出现故障，
  平台会感知到，并重新启动一台新的服务，始终保持三台的状态。
```
```
  ```
   从上图可以看出，redis起的作用不大。
   电力生产系统本身是基于内存计算的，而且每次都会重新计算。
   Redis缓存的一个重要指标是“缓存命中率”，如果这项指标低，Redis就没有起到应用的作用。
   Redis也中基于内存的，电力生产系统同样是基于内存。
   如果在Redis中缓存，也应考虑网络情况。
   电力生产系统用户在页面上的每一操作都会有一个请求。代表该系统的网络IO会很高。
   电力生产系统用户在页面上的每一操作都需要等待后端服务的响应。是一个同步操作，对时延的要求也很高。
   
```

###  思路二

``` plantuml
@startuml
   title 某电厂电力生产系统部署思路二
  
   
   database  电力生产数据库支持Oracle或者MySql as db
   
   node 网关&调度 as getway{
      component 异步网关 as agetway
      component 发布订阅 as mq
      agetway ---> mq   
  } 
   
   mq <---> [电力生产系统BO服务31]
   mq <---> [电力生产系统BO服务32]
   mq <---> [电力生产系统BO服务33]
   [电力生产系统BO服务31] --> [电力生产系统持久服务]
    [电力生产系统BO服务32] --> [电力生产系统持久服务]
     [电力生产系统BO服务33] --> [电力生产系统持久服务]
   
   
  [电力生产系统持久服务] ---  [db]
  
@enduml
```

```
  原有电力生产系统拆分为两部分：电力生产系统持久服务、电力生产系统BO服务，可以分别进行高可用部署。
  电力生系统BO服务存在会话状态，通过增加网关&高度服务来应对。
  
  当某一用户请求到来，网关会把该请求转发到所有的"电力生产系统BO服务"，
  该转发为异步的GRPC（为性能考虑，也可采用Http）。
  第一个响应会转发给用户客户端。
  其它响应记录日志，如发现有“电力生产系统BO服务”没有响应，
  需通知基础平台进行POD调度。
  
  当用户保存时，用户请求落在那个BO服务上，都为成为一个事务性工作任务。
  
  条件允许时也可以对“电力生产系统持久服务” 部署多个，实现高可用。
  
```


